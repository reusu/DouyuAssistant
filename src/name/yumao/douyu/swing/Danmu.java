package name.yumao.douyu.swing;

import java.awt.AWTException;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Insets;
import java.awt.MenuItem;
import java.awt.Point;
import java.awt.PopupMenu;
import java.awt.SystemTray;
import java.awt.Toolkit;
import java.awt.TrayIcon;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionAdapter;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.util.List;

import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import javax.swing.border.MatteBorder;

import name.teemo.api.vo.live.douyu.DouyuApiServersVo;
import name.yumao.douyu.http.HttpClientFromDouyu;
import name.yumao.douyu.mina.LoginMinaThread;
import name.yumao.douyu.utils.HexUtils;
import name.yumao.douyu.utils.NumUtils;
import name.yumao.douyu.utils.SttDecoder;


public class Danmu extends JFrame implements ActionListener{
	private static final long serialVersionUID = 1L;
	static Point origin = new Point();
	private JLabel titleLabel=new JLabel("斗鱼TV评论小助手");
	private JButton smallButton=new JButton("_");
	private JButton closeButton=new JButton("x");
	private JLabel nameLabel=new JLabel("请输入房间号：");
	private JButton butnSure=new JButton("连接");
	private JLabel supLabel=new JLabel(HttpClientFromDouyu.showAnnounce());
	private JTextField inNum=new JTextField(10);
	private JPanel titlePanel = new JPanel();
	private JPanel bodyPanel = new JPanel();
	public Danmu(){
		super("斗鱼TV评论小助手");
		Toolkit toolkit = Toolkit.getDefaultToolkit();
		setIconImage(toolkit.createImage(HexUtils.HexString2Bytes("89504E470D0A1A0A0000000D4948445200000038000000380806000001DF810B88000000017352474200AECE1CE900000006624B474400FF00FF00FFA0BDA793000000097048597300000B1300000B1301009A9C180000000774494D4507DE0312053905217589E50000001974455874436F6D6D656E74004372656174656420776974682047494D5057810E17000008E14944415468DEED9A7B8C54D51DC73FF7320B8B0CCB63898A458228A299094868BA546B2A3E428B6F306A8A96F155D052A458B556A3A041F191822BD1F89CC1B7205A158BB66A904503DAD54686D2BA2820E816505C9CD9C57DB0B77FDCEF09672F33B3B3B3E3A2945F72735FE7DC737EBFF37B7C7FBF731DCFF3C8462E3928944E442B8087C3B1E48874223A065865F75C0D8CD0FDAA4C9F9D924E4483837F1302DE077E0C78C0BF8134301D08BBC01D407F600650014C05A600573905B1924E4409A51351807F004380017A773EB0C80586E9C100ABE322F3D91A60B3660B40389604B8DD49C523A3816AE00C35780E98034C0969AC6A60A9585A2BF66A73B2D2DEA2D8F74B80899A4F36F657039B42C024E029603D50178E254927A203802FB3F4AD30127846CC1D05B44A02D93A1D6D2E9C543C72AB3A2CC8D1A1CD4A998EEBB43A1F01D38052E01EA019E80E2481BF0037028E66D754B0540BEEE8522015D4319D88F60C2AC0F4702C5999A5F16DC02B32D4AD21E0361D4DE158B2521FF224C136460ABCA7E7EB5DE005A029D068548641EF0EF2F8798646FFCC47381F03C36D83CBA2E4E7B6B10EA0AF2500B3A84E868EA3813EC063C01627158FDC02EC02EECA654E015D2D7352F188071C037C2067F5A8A6BE064801738179EA570DFC0E78C3B544DD0A3C0E3C09D44BC10F05EED5D4C74926AB805E21603CF013A03730188802DB809940A37CE912E0EFC072F9A193BBDE3ABAD4383A4341A3B2E947C096423F1C8E251DEBDB8700B380A9AE1580DE025EB4FA2C0DC7924E389674B4FA259A8493C731574ADF02DC2AF5BB12F8D4953A2D024E96D93CA801770726DD2CBB3D3B0F066FD0C021E066A041CFBD107035F00070A4C2424536052BCA1AEA98AAFB9F035B33ACC75EE1A63303B668F6E53AA764948D19904FBE5CDE0DFC01D8085C0B3C6FFA87AC465FE9DC5BE74B85A46CF20AD4D211D295A1AE06F280F940ADAE6700FFC95323331E01D17F048C051C5783003C010CD4F53DC0B11AFC5C0116CFD25E830A0C9E0CEBDA9323FDAFDA6ED033B3749E0B44F4F24F56C393ACD92DD4F9139D37EB03EB753F5C00D6AC6FADEC15455E14CDBA196C530C6D1F260CF40670A64165DF0BE7BDFF478BFD7FC050570D2447303863005686B21418231F5B087597833048EAC5F6381C0794E403023370E369C0EB85B4EB8047804B42F2004B803239D8970C063483490A43E4FDF3A1DDF23ED5F2A1CB819F0197BB42DAE729E247F4E1A0425D2CBFB82ECF019F0606297F5F1ED4D22A395680DB95BA0569B0CE43F21CF0D759D2085CE0A7D6FD31CAB4833447D0634031CC62BCC45523AF3E2D4BDBF78A6587B582891F5AA2FD4E3DCD2CCD7E530EB84021E6916DC00DBA5E5F442F7485807346912E94EA6E92C6AE01AE02C201D4560EECC873C08774C485BC371A3333B666C479ADF04C266AEC2097435519D920651C03B4E68218AB72A0F08EF8D29EC064A1FB7A27158FCC1606719507BF1444DB9D8C10368D3449F7572A4D4D931F2CE908E82D24006F57F6FEA19CF90C61CD3735F0DF14665E00BE552EF29A26572E0DF7E4FC97E97A96F0ECA3CAC85A80B1C188BFC5F2999F0023E5174F03FEAA22460F7D709726EC008BD5AFBF946B34F0B026532AA7DF0DE8E10672C143747E153818E827440E7082CA16265734B9485ADC005CA4C97D60158E5A55A50048BB56B9F0019533D64A84D556BD03F9DC3A5DCF55B2837292466081EEEFD47997CE13147C01EE7352F1C8E9C683C91EEDAAF504E50A4BACBCD164C05FC8D696E9FA02459A3E96244E509B2AE59ECB8A05F5176B22638177FEBF91779773B8DF23FD030C1E60B078B5D26C299C81FDBF052EEB442A5710A9BA55A26895897A2B109D079C5D08ECBC5AD1A846B5BBD7C3B1646D1724CFF30442B092831205A213551A3ACB7AEFA21D589B0E5346E70968649AF8C5F85B864777B1B635025E3A117D55C21DCF9ECDDA8D82F193809781C315BD879A52F0A5C07582602BD429A68FDC003C9B27F82CC5DF813E47D8E231F654653B4B7D85D42A34E74AE06D61A16051AF5C08DC0B01D700A7E2576B1BAC468BB4CCEF02BD842BDBA3387061A00272A3C056A7E2357013F0470BC0E59DF8F6912A366478DFAAE51FD401FBDCA9443A2DA07D6F1156CF23FBEE79BB61629ECEEFAB7661E858FC3F15BEC9912906699BB28DFEF2B4732C18BC6FC284D2A58BACE2CC95F24E2B84F75BF787407F24FE4F15EBF077C09AF1F7207ED0CC99153C481EF4577A76A83CD40EFC3F5DB25524F7020179A4F59D7132A11CC13D27830DAAC8AC51F4DF2E06ABF07F70380E7F8F65B3158FCA336CEED964678514C9C9546A1192F8BBFAAF03FF9253CBC9209ACC022B4F06BF185A895F2B7E48F1CD48735F60DC3AA5E5BDF077DF6ED1F39D2A22BCA690B65251A109ED1766A32F05811C8B3953D1688F9ABF03065B00371C4B1E27061D2DC205F8DB84BF91D679AA2F0D037615524370040A6E5651A34BA91DB0EDAAB4344A80E35427158F3407CA764D2A4A759333F94C7170217BFF84B42F522EAF23654627158FAC902A224773A18CF71A60B6741E399993804F2DC60629A087E5AC3649209EDE974BA26512D8C7F2CE03A55E6115E8D6C99B0F51BAD35D216A83C0C3602502AD02DAF5BAEF23FCBB55F3EAA7E7655AE1B5210D82957EF4D4F5025501C75999C674313E137F8B28A47859CA9E2DA16D52DD3A19BE8179F5C2A51EFEEE5A999E6F974A4DD7511AC0C3F3813FE3D7C757CBF14D00265AED9E52DB59B4FDB56DA26B3164ECCBB154B525A0BA3B65D47789B9AFE580465905C783F1EBB65FA8B6D768096FB726B8D8FAEE0E49FB7AD9F667D6BB13E52D47E2FF5C3A067F936E72A0C059A231E707A0E1B72E6DF7C63C8BA99996EA82BF31744740C2FD80DF4B0D6BACE7EF2AF49459365A22D51C091C61B5ED6185AB1AC53AB3E937501A5405DC6FF529A5ED1E4FB960E6707DCF503727158F348A6BB34FD04B936AC12FCBAF94835969ADF2F10207BF94BD80FF87CF3265106FE9D941F8FB47B375DD24491F2146774BC59FC0AF474F52206F00129AF0E77AFE76C0B19DC29E7FA89010EA815F583EA3AA18A566374FCFE604DAD8F70EFEE6D74D568A3650CC4D9646E4FBDDBDBCE8F7091BF795BA3B42233B3B0D620F54B67FE0F43F6B2EB630779B02D50000000049454E44AE426082")));
		setUndecorated(true);
		//主体大框
		Dimension dimension=toolkit.getScreenSize();
		setBounds((dimension.width-320)/2, (dimension.height-180)/2, 320, 180);
		setVisible(true);
		setResizable(false); 
		setLayout(null);
		addWindowListener(new WindowHandler());
		//分层背景丢上去
		titlePanel.setBounds(0, 0, 320, 30);
		titlePanel.setBackground(new Color(240,150,50));
		titlePanel.setBorder(new MatteBorder(0, 1, 0, 1, new Color(240,150,50)));
		add(titlePanel);
		bodyPanel.setBounds(0, 30, 320, 150);
		bodyPanel.setBackground(new Color(255,255,255));
		bodyPanel.setBorder(new MatteBorder(0, 1, 1, 1, new Color(240,150,50)));
		add(bodyPanel);
		//标题栏
		titleLabel.setBounds(10, 0, 160, 30);
		titleLabel.setFont(new Font("Microsoft Yahei",Font.BOLD,13));
		titleLabel.setForeground(new Color(255,255,255));
		add(titleLabel,0);
		//最小化以及关闭
		smallButton.setBounds(270, 0, 20, 30);
		smallButton.setFont(new Font("Microsoft Yahei",Font.BOLD,12));
		smallButton.setForeground(new Color(255,255,255));
		smallButton.setMargin(new Insets(0, 0, 0, 0));
		smallButton.setBorder(null);
		smallButton.setOpaque(false);
		smallButton.setIconTextGap(0);
		smallButton.setContentAreaFilled(false);
		smallButton.setFocusable(false);
		smallButton.addActionListener(this);
		add(smallButton,0);
		closeButton.setBounds(290, 0, 20, 30);
		closeButton.setFont(new Font("Microsoft Yahei",Font.BOLD,12));
		closeButton.setForeground(new Color(255,255,255));
		closeButton.setMargin(new Insets(0, 0, 0, 0));
		closeButton.setBorder(null);
		closeButton.setOpaque(false);
		closeButton.setIconTextGap(0);
		closeButton.setContentAreaFilled(false);
		closeButton.setFocusable(false);
		closeButton.addActionListener(this);
		add(closeButton,0);
		//body部分
		nameLabel.setBounds(45, 50, 100, 25);
		nameLabel.setFont(new Font("微软雅黑",Font.BOLD,13));
		nameLabel.setForeground(new Color(240,150,50));
		add(nameLabel,0);
		inNum.setBounds(45, 80, 100, 60);
		inNum.setFont(new Font("微软雅黑",Font.BOLD,32));
		inNum.setBorder(new MatteBorder(1, 1, 1, 1, new Color(240,150,50)));
		add(inNum,0);
		butnSure.setBounds(160,50,100,90);
		butnSure.setFont(new Font("微软雅黑",Font.BOLD,32));
		butnSure.setForeground(new Color(240,150,50));
		butnSure.setMargin(new Insets(0, 0, 0, 0));
		butnSure.setBorder(new MatteBorder(1, 1, 1, 1, new Color(240,150,50)));
		butnSure.setOpaque(false);
		butnSure.setIconTextGap(0);
		butnSure.setContentAreaFilled(false);
		butnSure.setFocusable(false);
		butnSure.addActionListener(this);
		add(butnSure,0);
		supLabel.setFont(new Font("微软雅黑",Font.BOLD,13));
		supLabel.setBounds(45,115,240,80);
		supLabel.setForeground(new Color(240,150,50));
		add(supLabel,0);
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		//最小化到任务栏
		PopupMenu popupMenu = new PopupMenu();
		MenuItem openDouyuContent = new MenuItem("打开");
		MenuItem exitDouyuContent = new MenuItem("退出");
		//打开按钮
		openDouyuContent.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				 setExtendedState(JFrame.NORMAL);
                 setVisible(true);
			}
		});
		//退出按钮
		exitDouyuContent.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				System.exit(0);
			}
		});
		//添加到菜单
		popupMenu.add(openDouyuContent);
		popupMenu.add(exitDouyuContent);
		SystemTray tray = SystemTray.getSystemTray();
		TrayIcon trayIcon = new TrayIcon(toolkit.createImage(HexUtils.HexString2Bytes("89504E470D0A1A0A0000000D49484452000000100000001008060000001FF3FF61000001814944415478DAC593CD4B024118C6DFEA608A54045AE41AB2EA7E78AE4B5197FE868E414175A90EDD3A641644D4C570C3569D193DD72DA8EE11DD3A7608223C5828BAEECCEA1F60B31D84F2833E0E0E3C0C33F0FE98F7799F01E8F92A273DEE7F012CAC6C52AC1C50AC1E7613C3CA11CB486B0D0D1C1616464D1C9EB790B26F0312464A5C305058EDA64A4A9CB290A45551789D611971609A839F806269CF6EA3AAC1909996964AE79362DB5663E0A644B9E6C5A48683B3862EF928966FC02272F413900CCEF0D73C1B485E6907B85C8481320E86DED3E0B2CF452DE4B1887ADB043CC6C0652269AEAE07BD3FF1AE05F05BF3FF0468C4A0BF05C0887A672139CA88B453CF86229D8A0BDBE0E42D6EB08C386DFBD10450A2966AD948C31625E1E57C2E3058880BCEEF2A6AE31E86D40B86941C9F449C22699511E51EF885CEF546916AF0FD8A8723C1A57D11CF8A89649D65E4133E2DBF1D223323EFF21C3CC0CB16384AFA98B772E69F30E282AFAAF9844ECA9F06469A7E00F4BD1E8BC3BDFF8C1F402EF90F8099330C0000000049454E44AE426082")),"斗鱼TV评论小助手",popupMenu);
		MouseAdapter iconAdap = new MouseAdapter() {
			public void mouseClicked(MouseEvent e) {
				if (e.getClickCount() == 2){
					setExtendedState(JFrame.NORMAL);
					setVisible(true);
				}
			}
		};
		trayIcon.addMouseListener(iconAdap);
		//防止程序崩溃 甩出错误信息
		try {
			tray.add(trayIcon);
		} catch (AWTException e) {
			e.printStackTrace();
		}
		//拖拽功能
		addMouseListener(new MouseAdapter() {
			public void mousePressed(MouseEvent e) {
				origin.x = e.getX();
				origin.y = e.getY();
			}
		});
		addMouseMotionListener(new MouseMotionAdapter() {
			public void mouseDragged(MouseEvent e) {
				Point p = getLocation();
				setLocation(p.x + e.getX() - origin.x, p.y + e.getY()- origin.y);
			}
		});
	}
	@Override
	public void actionPerformed(ActionEvent e) {
		if(e.getSource() == smallButton){
			this.setExtendedState(JFrame.ICONIFIED);
		}
		if(e.getSource() == closeButton){
			System.exit(0);
		}
		if (e.getSource() == butnSure) {
			String roomNum = "";
			inNum.setEditable(false);
			butnSure.setEnabled(false);
			if(NumUtils.isNumeric(inNum.getText())){
				roomNum = inNum.getText();
			}else{
				SttDecoder sttDecoder = new SttDecoder();
				sttDecoder.Parse(inNum.getText());
				if(sttDecoder.GetItem("type")!=null){
					roomNum = sttDecoder.GetItem("roomid");
				}else{
					// 进行房间参数的号码转换
					inNum.setText(HttpClientFromDouyu.QueryDouyuRoomNum(inNum.getText()));
					roomNum = inNum.getText();
				}
			}
			// 获取登入服务器列表
			List<DouyuApiServersVo> loginServerList = HttpClientFromDouyu.QueryLoginServer(roomNum);
			// 开始启动登入Mina线程
			LoginMinaThread loginMina = new LoginMinaThread(null,loginServerList,inNum,butnSure);
			Thread loginMinaThread = new Thread(loginMina);
			loginMinaThread.start();
		}
	}
	//窗口最小化将面板可见性关闭
	class WindowHandler extends WindowAdapter {
		public void windowIconified(WindowEvent e) {
			dispose();
		}
	}
}